# Security Review of [ollama_bash_lib.sh](../ollama_bash_lib.sh)

A [demo](../README.md#demos) of [Ollama Bash Lib](https://github.com/attogram/ollama-bash-lib) v0.43.8


```bash
task="Act as an Expert Security Professional.
Do a Security Review of this bash script.
Require that script works in Bash v3.2 or higher.
Output your review in Markdown format."
file="../ollama_bash_lib.sh"
ollama_generate "gpt-oss:120b" "$task\n\n$(cat "$file")"
```
# Security Review – **Ollama Bash Lib**  

*Prepared for Bash ≥ 3.2*  

---  

## 1. Summary  

| Area | Grade | Comments |
|------|-------|----------|
| **Overall design** | ★★☆☆☆ | Useful wrapper around the Ollama HTTP API, but several **high‑risk** behaviours (e.g. `eval` of model‑generated code) are exposed to the user without sufficient sandboxing. |
| **Input validation** | ★★☆☆☆ | Most functions correctly quote arguments, yet a few places construct JSON or shell commands with unchecked user‑controlled data (`_redact`, `ollama_generate_json`, `ollama_chat_json`, `ollama_eval`). |
| **Credential handling** | ★★☆☆☆ | API key (`OLLAMA_LIB_TURBO_KEY`) is stored in a regular shell variable and *exported* when Turbo mode is toggled – it can leak to child processes and the environment. |
| **Error handling & logging** | ★★★☆☆ | Good use of `_debug` and `_error`, but debugging output may inadvertently expose secrets if `OLLAMA_LIB_DEBUG=1`. |
| **Compatibility** | ★★★★★ | No Bash 3.2‑incompatible constructs (no associative arrays, no `declare -A`, no `${var@...}` expansions). The script should run on Bash 3.2+. |

**Bottom line:** The library works functionally, but it contains several security‑relevant issues that must be mitigated before it is used in an environment where untrusted input or users share the same shell.

---  

## 2. Threat Model  

| Asset | Threat | Impact | Likelihood |
|-------|--------|--------|------------|
| **API key (`OLLAMA_LIB_TURBO_KEY`)** | Accidental exposure via environment, logs, or `ps` output | Full access to Ollama Cloud (billing, data) | Medium |
| **User‑supplied prompt / model name** | Injection into JSON payload or into a shell command (`eval`) | Remote code execution, data exfiltration | High (if attacker can influence prompt) |
| **External commands (`curl`, `jq`, `timeout`, `shuf`, etc.)** | Replacement with malicious binaries in `$PATH` | Arbitrary code execution | Low‑Medium (depends on system hygiene) |
| **Debug output** | Leak of sensitive data (API key, raw JSON) | Confidentiality breach | Low‑Medium (when DEBUG enabled) |
| **File‑system side‑effects** | `ollama_eval` writes nothing but may invoke `eval` that modifies the environment | Privilege escalation / data loss | Low (requires successful injection) |

---  

## 3. Detailed Findings  

### 3.1. **Use of `eval` in `ollama_eval`**  

```bash
eval "$cmd"
```

* **Risk** – The command (`$cmd`) is generated by the LLM, which can be *untrusted* or *adversarial*. Even though a syntax check (`bash -n`) and a superficial “dangerous token” regex are performed, they do **not** guarantee safety:  

  * The regex only matches a static list of commands; an attacker can use alternate spellings (`/bin/rm`, `$(rm ...)`, `$(printf ...)`) or chain commands with `&&`/`;` that bypass the list.  
  * `bash -n` only checks syntax, not runtime behaviour.  

* **Impact** – Arbitrary command execution with the privileges of the user running the script.  

* **Recommendation**  

  * **Never** `eval` untrusted content. Replace with a **sandbox** (e.g. `docker run --rm -i bash:latest` or `bats`), or at the very least, run the generated command under `env -i bash -c` with a very limited `PATH`.  
  * If interactive execution is required, present the command to the user and let them copy‑paste it manually instead of auto‑executing.  

### 3.2. **Credential Leakage (`OLLAMA_LIB_TURBO_KEY`)**  

* The key is stored in a normal variable and later **exported**:

  ```bash
  export OLLAMA_LIB_API="$host_api"
  export OLLAMA_HOST="$host_api"
  ```

* Exported variables are visible to **all child processes** (including `ps e` and `/proc/$PID/environ`).  

* **Impact** – An attacker with access to any downstream process (or a compromised binary) can read the key and use the cloud API.  

* **Recommendation**  

  * Keep the key **unexported**; pass it to `curl` via a **header** built locally, not via the environment.  
  * If exporting is unavoidable, use a **restricted environment** for the call:

    ```bash
    OLLAMA_LIB_TURBO_KEY="$api_key" curl ...   # no export
    ```

  * Zero‑out the variable after use: `unset OLLAMA_LIB_TURBO_KEY`.  

### 3.3. **Potential JSON Injection**  

* Functions construct JSON payloads with user‑supplied strings (`model`, `prompt`, `messages`) via **`jq -c -n`**. This is safe *provided* that the values are passed as jq arguments (`--arg`). The script does this correctly.  

* However, `ollama_generate_json` passes `$2` (`prompt`) directly to `_debug`:

  ```bash
  _debug "ollama_generate_json: [${2:0:42}]"
  ```

  If `DEBUG=1`, the prompt (which may contain control characters) is printed to stderr.  

* **Impact** – Information disclosure; not a direct injection.  

* **Recommendation**  

  * Escape or truncate debug output more aggressively: `printf '%q'` or use `sed` to strip non‑printable characters.  

### 3.4. **Insufficient Validation of API Path**  

```bash
if [[ -n "$endpoint" && ( "$endpoint" != /* || "$endpoint" == *" "* || "$endpoint" == *"\\"* ) ]]; then
    _error "_call_curl: Invalid API Path: [$endpoint]"
    return 1
fi
```

* The test only rejects spaces and backslashes but **allows** characters like `;`, `&`, `|`, `$( )`, and URL‑encoded sequences (`%0A`). These can be interpreted by `curl` as part of the URL, potentially leading to **command injection** when combined with the `-H` or `-d` options.  

* **Recommendation**  

  * Restrict `endpoint` to a whitelist of known paths (`/api/generate`, `/api/chat`, …) or use a **regular expression** that permits only alphanumerics, slashes, hyphens, underscores, and dots:  

    ```bash
    [[ "$endpoint" =~ ^/api/[a-zA-Z0-9_/.-]+$ ]] || { _error "..."; return 1; }
    ```  

### 3.5. **Reliance on External Commands in `$PATH`**  

* Functions use `command -v` to test existence, but they **do not** lock down the `$PATH`. If an attacker can prepend a malicious directory, commands like `curl`, `jq`, or even `shuf` can be hijacked.  

* **Recommendation**  

  * Set a **trusted `$PATH`** early in the script, e.g.:

    ```bash
    export PATH="/usr/bin:/bin:/usr/local/bin"
    ```

  * Optionally, reference commands via absolute paths (`/usr/bin/curl`).  

### 3.6. **Debug Logging May Leak Sensitive Data**  

* `_debug` prints the **raw, redacted** string, but redaction only covers `OLLAMA_LIB_TURBO_KEY`. Other secrets (e.g., model‑specific prompts that include passwords) are not filtered.  

* **Recommendation**  

  * Make debug logging opt‑in **per session** and ensure that any variable that may contain secrets is passed through `_redact` first.  

### 3.7. **Potential Race Conditions with Global Variables**  

* Many functions modify **global** variables (`OLLAMA_LIB_STREAM`, `OLLAMA_LIB_THINKING`, `OLLAMA_LIB_MESSAGES`). If the library is sourced by a script that runs **concurrent subshells**, state can be corrupted.  

* **Recommendation**  

  * Document that the library is **not thread‑safe**.  
  * Prefer passing state through function arguments or using **local** variables when possible.  

### 3.8. **Use of `timeout` without checking its existence**  

* `ollama_eval` runs:  

  ```bash
  if ! errors=$(timeout 1 bash -n <<<"$cmd" 2>&1); then
  ```

* If `timeout` is missing, the script will abort with an error code that could be mistaken for a Bash syntax error.  

* **Recommendation**  

  * Verify `_exists timeout` before use, or provide a fallback (e.g., simple `bash -n`).  

### 3.9. **Potential Directory Traversal in `ollama_model_random`**  

* The function extracts model names from `ollama list` output, then randomly selects one. If the user’s `PATH` or `ollama` binary is compromised, an attacker could inject arbitrary strings that contain newline characters, leading to command injection in downstream calls (e.g., when the model name is passed to `ollama_api_post`).  

* **Recommendation**  

  * Sanitize model names with the same pattern used in `_is_valid_model`.  

---  

## 4. Compatibility with Bash 3.2  

| Feature | Bash 3.2 Support | Status |
|---------|------------------|--------|
| Arrays (`arr=(); arr+=()`) | ✔︎ | ✅ |
| `local` variables | ✔︎ | ✅ |
| Arithmetic `$(( ))` | ✔︎ | ✅ |
| Parameter expansion `${var//pattern/repl}` | ✔︎ | ✅ |
| `PIPESTATUS` | ✔︎ | ✅ |
| `set -o pipefail` | ✔︎ | ✅ |
| `[[ ... =~ ... ]]` (regex) | ✔︎ (basic) | ✅ (used only for simple patterns) |
| `read -r -s` (silent read) | ✔︎ | ✅ |
| `printf '%s'` with large strings | ✔︎ | ✅ |
| Bash version detection (`${BASH_VERSION}`) | ✔︎ | ✅ |

The script **avoids** Bash‑3.2‑incompatible constructs such as associative arrays, namerefs (`declare -n`), or `${var@Q}`. It should run unchanged on Bash 3.2.

---  

## 5. Recommendations – Short‑Term & Long‑Term  

| Category | Action | Priority |
|----------|--------|----------|
| **Critical** | Remove or heavily sandbox `eval` in `ollama_eval`. Provide a *manual‑confirm‑and‑run* workflow instead of auto‑execution. | High |
| **Critical** | Stop exporting `OLLAMA_LIB_TURBO_KEY`. Use a temporary variable scoped to the curl call, and `unset` it immediately after. | High |
| **High** | Tighten `endpoint` validation in `_call_curl` to a whitelist or strict regex. | High |
| **Medium** | Harden the environment: set a fixed `$PATH` and optionally use absolute command paths. | Medium |
| **Medium** | Improve redaction: funnel all debug output through `_redact` and expand the redaction list to include keywords like `password`, `secret`, etc. | Medium |
| **Medium** | Add existence checks for `timeout` and other optional binaries before using them. | Medium |
| **Low** | Document that the library is not safe for concurrent use; recommend sourcing it in a dedicated process per operation. | Low |
| **Low** | In `ollama_model_random`, validate the selected model name with `_is_valid_model` before returning. | Low |
| **Low** | Replace the *dangerous token* regex with a more exhaustive check (e.g., use `grep -E` with `\b` and a negative look‑ahead for safe tokens). | Low |

---  

## 6. Conclusion  

The **Ollama Bash Lib** is a well‑structured wrapper for the Ollama API, but its current design gives **untrusted LLM output** a direct path to code execution via `eval`. Credential handling and environment variable exposure also present moderate risk. With the mitigations listed above—especially removing `eval` and protecting the API key—the library can be hardened for production use while remaining compatible with Bash 3.2.  

---  

*Prepared by:  
Security Analyst (Bash‑3.2 compatibility specialist)*  
